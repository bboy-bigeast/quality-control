{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                {% if mode == 'create' %}干膜产品{% else %}编辑产品信息{% endif %}
            </h3>
        </div>
        
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <!-- 基本信息组 -->
                <div class="mb-4">
                    <h4 class="border-bottom pb-2">基本信息</h4>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">批号</label>
                            {{ form.batch_number }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">产品牌号</label>
                            {{ form.product_id }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">产线</label>
                            {{ form.production_line }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">检测人</label>
                            {{ form.inspector }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">测试日期</label>
                            {{ form.test_date }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">样品类别</label>
                            {{ form.sample_type }}
                        </div>
                        <div class="col-12">
                            <label class="form-label">备注</label>
                            {{ form.remarks }}
                        </div>
                    </div>
                </div>
                
                
                <!-- 产品数据组 -->
                <div class="mb-4">
                    <h4 class="border-bottom pb-2">产品数据</h4>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">外观</label>
                            {{ form.appearance }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">固含</label>
                            {{ form.solid_content }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">粘度</label>
                            {{ form.viscosity }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">酸值</label>
                            {{ form.acid_value }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">水分</label>
                            {{ form.moisture }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">残单</label>
                            {{ form.residue }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">重均分子量</label>
                            {{ form.molecular_weight }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">PDI</label>
                            {{ form.pdi }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">色度</label>
                            {{ form.color }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">阻聚剂</label>
                            {{ form.inhibitor }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">转化率</label>
                            {{ form.conversion_rate }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">装车温度</label>
                            {{ form.loading_temp }}
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" class="btn btn-primary" name="action" value="judge">结果判定</button>
                    <button type="submit" class="btn btn-primary" name="action" value="save">保存数据</button>
                    <a href="{% url 'dryfilm_list' %}" class="btn btn-outline-secondary">返回列表</a>
                </div>
            </form>

            <!-- 判定结果组 (只显示一次) -->
            <div class="mb-4">
                <h4 class="border-bottom pb-2">判定结果</h4>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fs-5">出厂判定</label>
                        <p class="d-block my-2">  <!-- 添加d-block和my-2增加上下边距 -->
                            <span class="badge fs-5
                                        {% if product.factory_judgment == 'qualified' %}bg-success
                                        {% elif product.factory_judgment == 'unqualified' %}bg-danger
                                        {% else %}bg-warning{% endif %} 
                                        p-2">  <!-- 添加p-2增加内边距 -->
                                {{ product.get_factory_judgment_display }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fs-5">内控判定</label>
                        <p class="d-block my-2">  <!-- 添加d-block和my-2增加上下边距 -->
                            <span class="badge fs-5
                                        {% if product.internal_judgment == 'qualified' %}bg-success
                                        {% elif product.internal_judgment == 'unqualified' %}bg-danger
                                        {% else %}bg-warning{% endif %} 
                                        p-2">  <!-- 添加p-2增加内边距 -->
                                {{ product.get_internal_judgment_display }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- 变更日志 - 只在编辑模式显示 -->
    {% if mode == 'edit' %}
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">变更日志</h5>
        </div>
        <div class="card-body">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>字段</th>
                        <th>旧值</th>
                        <th>新值</th>
                    </tr>
                </thead>
                <tbody>
                    {% for change in product.change_log %}
                    <tr>
                        <td>{{ change.timestamp|date:"Y-m-d H:i" }}</td>
                        <td>{{ change.field }}</td>
                        <td>{{ change.old_value }}</td>
                        <td>{{ change.new_value }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">暂无变更记录</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
</script>

<style>
/* 紫色主题表单样式 */
.card-header {
    background: linear-gradient(135deg, #11b8cb 0%, #7025fc 100%);
}

.border-primary {
    border-color: #6a11cb !important;
}

.text-primary {
    color: #6a11cb !important;
}

.form-label {
    color: #5a4fcf;
    font-weight: 500;
}

.form-control:focus, .form-select:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 0 0.25rem rgba(106, 17, 203, 0.25);
}

.invalid-feedback {
    color: #dc3545;
}
</style>
{% endblock %}